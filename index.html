<!DOCTYPE html>
<html>
<head>
    <title>Power Rankings App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #2c2c2c;
            color: #e0e0e0;
        }
        .container {
            background-color: #3a3a3a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid #555;
        }
        h1 {
            color: #ffffff;
            margin-bottom: 10px;
        }
        .description {
            color: #b0b0b0;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }
        input[type="text"] {
            width: 300px;
            padding: 12px;
            border: 2px solid #555;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
            background-color: #4a4a4a;
            color: #ffffff;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            background-color: #505050;
        }
        .submit-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .submit-button:hover {
            background-color: #0056b3;
        }
        .submit-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            margin-top: 15px;
            color: #b0b0b0;
        }
        .error {
            color: #ff6b6b;
            margin-top: 10px;
            display: none;
        }
        .help-text {
            font-size: 14px;
            color: #b0b0b0;
            margin-top: 8px;
        }
        
        /* Mobile responsive styles */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                margin: 0;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .description {
                font-size: 14px;
                margin-bottom: 25px;
            }
            
            input[type="text"] {
                width: 100%;
                max-width: 280px;
                padding: 10px;
                font-size: 14px;
            }
            
            .submit-button {
                padding: 10px 25px;
                font-size: 14px;
            }
            
            .help-text {
                font-size: 12px;
            }
            
            /* League preview mobile styles */
            #leaguePreview {
                padding: 15px !important;
                margin-top: 20px !important;
            }
            
            #leaguePreview h3 {
                font-size: 18px !important;
                margin-bottom: 12px !important;
            }
            
            #leaguePreview p {
                font-size: 14px !important;
                margin-bottom: 15px !important;
            }
            
            #teamsList {
                max-height: 300px !important;
            }
            
            #teamsList > div {
                padding: 8px 10px !important;
                margin: 4px 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
            }
            
            #teamsList img {
                width: 35px !important;
                height: 35px !important;
                margin-right: 0 !important;
                margin-bottom: 5px !important;
            }
            
            #teamsList .team-info {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }
            
            #teamsList .team-name {
                font-size: 14px !important;
                margin-bottom: 2px !important;
            }
            
            #teamsList .team-stats {
                font-size: 12px !important;
            }
            
            #startRankingBtn, #editLeagueBtn {
                padding: 12px 20px !important;
                font-size: 14px !important;
                margin: 8px !important;
                display: block !important;
                width: 100% !important;
                max-width: 200px !important;
            }
            
            /* League selection mobile styles */
            #leagueSelection {
                padding: 15px !important;
                margin-top: 20px !important;
            }
            
            #leagueSelection h3 {
                font-size: 18px !important;
            }
            
            #leaguesList > div {
                padding: 12px !important;
                margin: 8px 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
            }
            
            #leaguesList .league-name {
                font-size: 16px !important;
                margin-bottom: 4px !important;
            }
            
            #leaguesList .league-details {
                font-size: 12px !important;
                margin-bottom: 2px !important;
            }
            
            #leaguesList .select-button {
                margin-top: 8px !important;
                padding: 8px 16px !important;
            }
            
            #backToInputBtn {
                padding: 10px 20px !important;
                font-size: 14px !important;
                width: 100% !important;
                max-width: 200px !important;
            }
        }
        
        @media screen and (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .description {
                font-size: 13px;
            }
            
            input[type="text"] {
                max-width: 250px;
                padding: 8px;
                font-size: 13px;
            }
            
            .submit-button {
                padding: 8px 20px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Fantasy Football Power Rankings üèÜ</h1>
        <p class="description">Create power rankings for your fantasy football league using head-to-head team comparisons</p>
        
        <form method="post" id="leagueForm">
            <div class="form-group">
                <label for="league_id">Sleeper Username or League ID:</label>
                <input type="text" 
                       id="league_id" 
                       name="league_id" 
                       required 
                       placeholder="Enter your Sleeper username or league ID">
                <div class="help-text">
                    You can find your league ID in your league under "general settings"
                </div>
            </div>
            
            <button type="submit" class="submit-button" id="submitBtn">
                Get League Data
            </button>
            
            <div class="loading" id="loadingDiv">
                üîÑ Loading league data...
            </div>
            
            <div class="error" id="errorDiv">
                ‚ùå Invalid league ID or league not found. Please check and try again.
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('leagueForm');
        const leagueIdInput = document.getElementById('league_id');
        const submitBtn = document.getElementById('submitBtn');
        const loadingDiv = document.getElementById('loadingDiv');
        const errorDiv = document.getElementById('errorDiv');

        // Add input validation
        leagueIdInput.addEventListener('input', function() {
            const value = this.value.trim();
            errorDiv.style.display = 'none';
            
        });

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Always prevent default form submission
            
            const leagueId = leagueIdInput.value.trim();
            
            // Validate league ID
            if (!leagueId) {
                showError('Please enter a league ID or username');
                return;
            }

            // Fetch league data from API
            fetchLeagueData(leagueId);
        });

        async function fetchLeagueData(leagueId) {

            const user_data = await fetch(`https://api.sleeper.app/v1/user/${leagueId}`).then(res => res.json());
            if (user_data === null) {
                showLoading();
                try {
                    // Fetch league info, users and rosters data
                    const [leagueResponse, usersResponse, rostersResponse] = await Promise.all([
                        fetch(`https://api.sleeper.app/v1/league/${leagueId}`),
                        fetch(`https://api.sleeper.app/v1/league/${leagueId}/users`),
                        fetch(`https://api.sleeper.app/v1/league/${leagueId}/rosters`)
                    ]);
                    
                    if (!leagueResponse.ok || !usersResponse.ok || !rostersResponse.ok) {
                        throw new Error('League not found or API error');
                    }
                    
                    const league = await leagueResponse.json();
                    const users = await usersResponse.json();
                    const rosters = await rostersResponse.json();
                    
                    if (!users || !rosters || users.length === 0) {
                        throw new Error('No data found for this league');
                    }
                    
                    // Process the data (similar to your Django views)
                    const processedTeams = processLeagueData(users, rosters, league);
                    
                    // Show preview of teams
                    showLeaguePreview(processedTeams, leagueId);
                    
                } catch (error) {
                    console.error('Error fetching league data:', error);
                    showError('Could not fetch data. Please check username or league ID and try again.');
                }
            } else {
                const user_id = user_data.user_id;
                let year = new Date().getFullYear();
                if (new Date().getMonth() < 2) {
                    year -= 1;
                }
                const leagues = await fetch(`https://api.sleeper.app/v1/user/${user_id}/leagues/nfl/${year}`).then(res => res.json());
                console.log('Leagues for user:', leagues);
                
                if (leagues && leagues.length > 0) {
                    showLeagueSelection(leagues, user_data);
                } else {
                    showError('No leagues found for this user in 2025 season');
                }
            }
        }
        
        function processLeagueData(users, rosters, league) {
            // Process users data
            const processedUsers = users.map(user => ({
                user_id: user.user_id,
                avatar: user.avatar,
                name: (user.metadata && user.metadata.team_name) ? user.metadata.team_name : user.display_name,
                league_name: league.name || "My League"
            }));
            
            // Merge with roster data
            const teams = processedUsers.map(user => {
                const roster = rosters.find(r => r.owner_id === user.user_id);
                if (roster && roster.settings) {
                    return {
                        ...user,
                        wins: roster.settings ? roster.settings.wins || 0 : 0,
                        losses: roster.settings ? roster.settings.losses || 0 : 0,
                        fpts: roster.settings ? roster.settings.fpts || 0 : 0,
                        players: roster.players || []
                    };
                }
                return {
                    ...user,
                    wins: 0,
                    losses: 0,
                    fpts: 0,
                    players: []
                };
            });
            
            return teams;
        }
        
        function showLeagueSelection(leagues, userData) {
            // Hide loading and error
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Create league selection section
            const selectionDiv = document.createElement('div');
            selectionDiv.id = 'leagueSelection';
            selectionDiv.style.marginTop = '30px';
            selectionDiv.style.padding = '20px';
            selectionDiv.style.backgroundColor = '#4a4a4a';
            selectionDiv.style.borderRadius = '8px';
            selectionDiv.style.border = '1px solid #666';
            
            selectionDiv.innerHTML = `
                <h3 style="color: #ffffff; margin-bottom: 15px;">üìã Select a League to Rank</h3>
                <p style="color: #b0b0b0; margin-bottom: 20px;">Found ${leagues.length} league${leagues.length > 1 ? 's' : ''} for ${userData.display_name || userData.username}:</p>
                <div id="leaguesList" style="text-align: left; max-height: 400px; overflow-y: auto;"></div>
                <div style="margin-top: 20px;">
                    <button type="button" id="backToInputBtn" style="background-color: #555; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer;">
                        ‚Üê Back to Input
                    </button>
                </div>
            `;
            
            // Remove existing preview if any
            const existingPreview = document.getElementById('leaguePreview');
            const existingSelection = document.getElementById('leagueSelection');
            if (existingPreview) existingPreview.remove();
            if (existingSelection) existingSelection.remove();
            
            // Add selection to container
            document.querySelector('.container').appendChild(selectionDiv);
            
            // Populate leagues list
            const leaguesList = document.getElementById('leaguesList');
            leagues.forEach((league, index) => {
                const leagueDiv = document.createElement('div');
                leagueDiv.style.display = 'flex';
                leagueDiv.style.alignItems = 'center';
                leagueDiv.style.padding = '12px';
                leagueDiv.style.margin = '8px 0';
                leagueDiv.style.backgroundColor = '#555';
                leagueDiv.style.borderRadius = '6px';
                leagueDiv.style.border = '1px solid #777';
                leagueDiv.style.cursor = 'pointer';
                leagueDiv.style.transition = 'background-color 0.3s';

                let league_positions = "";
                let num_bench = 0;
                for (i = 0; i < league.roster_positions.length; i++) {
                    if (league.roster_positions[i] === "BN") {
                        num_bench++;
                    } else {
                        league_positions += league.roster_positions[i] + ", ";
                    }
                }   
                
                leagueDiv.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#666';
                });
                leagueDiv.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#555';
                });
                
                leagueDiv.innerHTML = `
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; color: #ffffff; font-size: 16px;">${league.name || `League ${league.league_id}`}</div>
                        <div style="font-size: 14px; color: #b0b0b0; margin-top: 4px;">
                            ${league.total_rosters} teams ‚Ä¢ ${league_positions || 'N/A'}${num_bench > 0 ? `${num_bench} BN` : ''}
                        </div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">
                            League ID: ${league.league_id}
                        </div>
                    </div>
                    <div style="padding: 8px 16px; background-color: #007bff; color: white; border-radius: 4px; font-size: 14px;">
                        Select ‚Üí
                    </div>
                `;
                
                leagueDiv.addEventListener('click', function() {
                    selectLeague(league.league_id);
                });
                
                leaguesList.appendChild(leagueDiv);
            });
            
            // Add back button event listener
            document.getElementById('backToInputBtn').addEventListener('click', function() {
                selectionDiv.remove();
                leagueIdInput.value = '';
                leagueIdInput.focus();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get League Data';
            });
        }
        
        function selectLeague(leagueId) {
            // Remove the selection interface
            const selectionDiv = document.getElementById('leagueSelection');
            if (selectionDiv) {
                selectionDiv.remove();
            }
            
            // Fetch the selected league's data
            fetchLeagueData(leagueId);
        }
        
        function showLeaguePreview(teams, leagueId) {
            // Log the league name from the first team (since all teams have the same league name)
            console.log('League name:', teams.length > 0 ? teams[0].league_name : 'Unknown');
            // Log all players from all teams
            console.log('All teams:', teams);
            teams.forEach((team, index) => {
                console.log(`Team ${index + 1} (${team.name}):`, team.players);
            });
            
            // Get all unique players across all teams
            const allPlayers = teams.flatMap(team => team.players || []);
            console.log('All player IDs:', allPlayers);
            console.log('Total players across all teams:', allPlayers.length);
            
            // Hide loading and error
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Create preview section
            const previewDiv = document.createElement('div');
            previewDiv.id = 'leaguePreview';
            previewDiv.style.marginTop = '30px';
            previewDiv.style.padding = '20px';
            previewDiv.style.backgroundColor = '#4a4a4a';
            previewDiv.style.borderRadius = '8px';
            previewDiv.style.border = '1px solid #666';
            
            previewDiv.innerHTML = `
                <h3 style="color: #ffffff; margin-bottom: 15px;">${teams[0].league_name}</h3>
                <p style="color: #b0b0b0; margin-bottom: 20px;">Found ${teams.length} teams in this league:</p>
                <div id="teamsList" style="text-align: left; max-height: 300px; overflow-y: auto;"></div>
                <div style="margin-top: 20px;">
                    <button type="button" id="startRankingBtn" class="submit-button">
                        Start Power Rankings
                    </button>
                    <button type="button" id="editLeagueBtn" style="margin-left: 10px; background-color: #555; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer;">
                        Try Different League
                    </button>
                </div>
            `;
            
            // Remove existing preview if any
            const existingPreview = document.getElementById('leaguePreview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Add preview to container
            document.querySelector('.container').appendChild(previewDiv);
            
            // Populate teams list
            const teamsList = document.getElementById('teamsList');
            teams.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.style.display = 'flex';
                teamDiv.style.alignItems = 'center';
                teamDiv.style.padding = '8px 12px';
                teamDiv.style.margin = '5px 0';
                teamDiv.style.backgroundColor = '#555';
                teamDiv.style.borderRadius = '6px';
                teamDiv.style.border = '1px solid #777';
                
                teamDiv.innerHTML = `
                    <img src="${team.avatar ? `https://sleepercdn.com/avatars/${team.avatar}` : 'https://sleepercdn.com/avatars/default_avatar.png'}" 
                         style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px;">
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; color: #ffffff;">${team.name}</div>
                        <div style="font-size: 14px; color: #b0b0b0;">${team.wins}-${team.losses} (${team.fpts} pts)</div>
                    </div>
                `;
                
                teamsList.appendChild(teamDiv);
            });
            
            // Add event listeners for buttons
            document.getElementById('startRankingBtn').addEventListener('click', function() {
                // Pass the team data directly to the ranking page
                startRankingsWithData(teams, leagueId);
            });
            
            document.getElementById('editLeagueBtn').addEventListener('click', function() {
                // Remove preview and reset form
                previewDiv.remove();
                leagueIdInput.value = '';
                leagueIdInput.focus();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get League Data';
            });
        }
        
        function startRankingsWithData(teams, leagueId) {
            // Store the team data in sessionStorage
            sessionStorage.setItem('leagueData', JSON.stringify({
                teams: teams,
                leagueId: leagueId
            }));
            
            // Navigate to the rankings page   
            window.location.href = 'league_detail.html';
        }

        function showError(message) {
            errorDiv.textContent = `‚ùå ${message}`;
            errorDiv.style.display = 'block';
            loadingDiv.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Get League Data';
        }

        function showLoading() {
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Loading...';
        }

        // Add keyboard shortcuts
        leagueIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });

        // Auto-focus on the input field
        window.addEventListener('load', function() {
            leagueIdInput.focus();
        });
    </script>
</body>
</html>